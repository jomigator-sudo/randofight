<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RandoFight Text Battles</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AdSlJbETclTcEvT1E_8m2VuaNbtIvVvaPdAZEDRzMmwS1k8wJV2yhLaMNJ-B0zRLCC9PZrzEq2bFzzsu&currency=USD"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .title { text-align: center; font-size: 3em; margin-bottom: 30px; color: #ff6b6b; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .game-screen { display: none; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 100; }
        .fighter-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .fighter-slot { border: 2px solid #4ecdc4; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(78, 205, 196, 0.1); }
        .fighter-slot:hover { background: rgba(78, 205, 196, 0.2); transform: translateY(-2px); }
        .fighter-slot.locked { border-color: #666; background: rgba(102, 102, 102, 0.1); cursor: not-allowed; }
        .fighter-slot.locked:hover { background: rgba(102, 102, 102, 0.1); transform: none; }
        .slot-number { font-size: 1.2em; color: #4ecdc4; margin-bottom: 10px; }
        .fighter-name { font-size: 1.1em; margin: 10px 0; }
        .fighter-level { color: #ffd93d; }
        .fighter-wins { color: #6bcf7f; }
        .ui-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 1em; transition: all 0.3s ease; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: #4ecdc4; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #45b7aa; }
        .btn-secondary { background: #6c5ce7; color: #fff; }
        .btn-secondary:hover { background: #5f4fcf; }
        .btn-fight { background: #ff6b6b; color: #fff; font-weight: bold; box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3); }
        .btn-fight:hover:not(:disabled) { background: #ff5252; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255, 107, 107, 0.4); }
        .btn-fight:disabled { background: #666; box-shadow: none; }
        .creation-form { max-width: 400px; margin: 0 auto; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #4ecdc4; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #4ecdc4; border-radius: 4px; background: rgba(0, 0, 0, 0.3); color: #fff; font-family: inherit; }
        .fighter-details { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .stats-panel, .inventory-panel { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; }
        .panel-title { font-size: 1.3em; color: #4ecdc4; margin-bottom: 15px; text-align: center; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .equipment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .equipment-slot { padding: 8px; border: 1px solid #666; border-radius: 4px; text-align: center; font-size: 0.8em; min-height: 80px; display: flex; flex-direction: column; background: rgba(0, 0, 0, 0.2); }
        .slot-name { font-size: 0.7em; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .item-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 3px; }
        .item-power { font-size: 0.8em; color: #ffd93d; font-weight: bold; }
        .item-name { font-size: 0.8em; font-weight: bold; }
        .fight-status { text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; }
        .diamonds-display { font-size: 1.2em; margin-bottom: 10px; color: #ffd93d; }
        .cooldown-timer { color: #e74c3c; font-weight: bold; }
        .fighters-display { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
        .fighter-card { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center; }
        .hp-bar { width: 100%; height: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #6bcf7f; border-radius: 10px; transition: width 0.5s ease; }
        .fight-log { background: rgba(0, 0, 0, 0.3); padding: 25px; border-radius: 10px; height: 300px; overflow-y: auto; margin-bottom: 20px; font-size: 1em; line-height: 1.4; font-family: 'Courier New', monospace; color: #f0f0f0; }
        .fight-log p { margin-bottom: 8px; text-indent: 0; }
        .story-title { font-size: 1.1em; font-weight: bold; color: #4ecdc4; text-align: center; margin-bottom: 10px; }
        .damage { color: #ff6b6b; font-weight: bold; }
        .heal { color: #6bcf7f; font-weight: bold; }
        .special { color: #ffd93d; font-weight: bold; }
        .critical { color: #ff8c42; font-weight: bold; }
        .dodge { color: #74b9ff; font-style: italic; }
        .victory { color: #00b894; font-weight: bold; font-size: 1.1em; }
        .defeat { color: #e17055; font-weight: bold; }
        .level-up { color: #fdcb6e; font-weight: bold; }
        .exp-gain { color: #81ecec; }
        .leaderboard { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto; }
        .leaderboard-entry { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .leaderboard-entry:nth-child(1) { color: #ffd700; }
        .leaderboard-entry:nth-child(2) { color: #c0c0c0; }
        .leaderboard-entry:nth-child(3) { color: #cd7f32; }
        .common { color: #9d9d9d; }
        .uncommon { color: #1eff00; }
        .rare { color: #0070dd; }
        .epic { color: #a335ee; }
        .legendary { color: #ff8000; }
        .mythic { color: #ff0000; }
        .paypal-button-container { margin: 10px 0; display: inline-block; }
        @media (max-width: 768px) {
            .fighter-details { grid-template-columns: 1fr; }
            .fighters-display { grid-template-columns: 1fr; }
            .title { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">RandoFight</h1>

        <!-- Login Screen -->
        <div id="loginScreen" class="game-screen" style="display: block;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #4ecdc4; font-size: 2.5em; margin-bottom: 10px;">Welcome to RandoFight</h2>
                <p style="color: #ccc; font-size: 1.1em;">Login or create an account to save your progress</p>
            </div>

            <div class="creation-form">
                <div id="loginForm">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #4ecdc4;">Login</h3>
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="loginUser()">Login</button>
                        <button class="btn btn-secondary" onclick="showSignupForm()">Create Account</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" style="background: #6c757d; color: #fff; font-size: 0.9em;" onclick="showForgotPasswordForm()">Forgot Password?</button>
                    </div>
                    <div style="text-align: center; margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
                        <button class="btn" style="background: #28a745; color: #fff; font-size: 1em; padding: 12px 24px;" onclick="playAsGuest()">Play as Guest</button>
                        <p style="color: #888; font-size: 0.8em; margin-top: 10px;">Play without an account (progress saved locally)</p>
                    </div>
                </div>

                <div id="signupForm" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #4ecdc4;">Create Account</h3>
                    <div class="form-group">
                        <label for="signupEmail">Email:</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password:</label>
                        <input type="password" id="signupPassword" placeholder="Choose a password (min 6 characters)">
                    </div>
                    <div class="form-group">
                        <label for="signupUsername">Username:</label>
                        <input type="text" id="signupUsername" placeholder="Choose a username" maxlength="20">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="signupUser()">Create Account</button>
                        <button class="btn btn-secondary" onclick="showLoginForm()">Back to Login</button>
                    </div>
                </div>

                <div id="forgotPasswordForm" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #4ecdc4;">Reset Password</h3>
                    <p style="text-align: center; margin-bottom: 20px; color: #ccc; font-size: 0.9em;">
                        Enter your email address and we'll send you a link to reset your password.
                    </p>
                    <div class="form-group">
                        <label for="resetEmail">Email:</label>
                        <input type="email" id="resetEmail" placeholder="Enter your email address">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="sendPasswordReset()">Send Reset Link</button>
                        <button class="btn btn-secondary" onclick="showLoginForm()">Back to Login</button>
                    </div>
                </div>

                <div id="resetPasswordForm" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #4ecdc4;">Set New Password</h3>
                    <p style="text-align: center; margin-bottom: 20px; color: #ccc; font-size: 0.9em;">
                        Enter your new password below.
                    </p>
                    <div class="form-group">
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password:</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="resetPassword()">Update Password</button>
                        <button class="btn btn-secondary" onclick="showLoginForm()">Back to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character Select Screen -->
        <div id="titleScreen" class="game-screen" style="display: none;">
            <button class="btn btn-secondary" style="position: absolute; top: 20px; right: 20px;" onclick="logoutUser()">Logout</button>
            <div style="text-align: center; margin-bottom: 30px; margin-top: 60px;">
                <h2 style="color: #4ecdc4; font-size: 2.5em; margin-bottom: 10px;">Character Select</h2>
                <p style="color: #ccc; font-size: 1.1em;">Welcome back, <span id="usernameDisplay">Player</span>!</p>
                <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; border-radius: 5px; padding: 10px; margin: 15px auto; max-width: 600px;">
                    <p style="color: #22c55e; font-size: 0.9em; margin: 0;">✅ <strong>Cloud Save Enabled:</strong> Your characters are automatically saved and will persist across devices and sessions!</p>
                </div>
            </div>

            <div class="ui-buttons">
                <span style="color: #ffd93d; font-size: 1.2em; margin-right: 20px;">Diamonds: <span id="titleDiamonds">0</span> 💎</span>
                <div id="titlePaypalButton" class="paypal-button-container"></div>
                <button class="btn btn-secondary" onclick="showLeaderboard()">Leaderboard</button>
            </div>

            <div class="fighter-slots">
                <div class="fighter-slot" id="slot-container-0" onclick="selectFighter(0)">
                    <div class="slot-number">Slot 1</div>
                    <div class="fighter-name">Empty Slot</div>
                    <div>Click to create fighter</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-1" onclick="purchaseSlot(1)">
                    <div class="slot-number">Slot 2</div>
                    <div>Purchase this slot for 100 💎</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-2" onclick="purchaseSlot(2)">
                    <div class="slot-number">Slot 3</div>
                    <div>Purchase this slot for 100 💎</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-3" onclick="purchaseSlot(3)">
                    <div class="slot-number">Slot 4</div>
                    <div>Purchase this slot for 100 💎</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-4" onclick="purchaseSlot(4)">
                    <div class="slot-number">Slot 5</div>
                    <div>Purchase this slot for 100 💎</div>
                </div>
            </div>
        </div>

        <!-- Fighter Creation Screen -->
        <div id="creationScreen" class="game-screen">
            <button class="btn btn-secondary back-btn" onclick="showTitleScreen()">← Back</button>
            <div class="creation-form">
                <h2 style="text-align: center; margin-bottom: 20px; color: #4ecdc4;">Create New Fighter</h2>
                <div class="form-group">
                    <label for="fighterName">Fighter Name:</label>
                    <input type="text" id="fighterName" maxlength="20" placeholder="Enter fighter name">
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="createFighter()">Create Fighter</button>
                    <button class="btn btn-secondary" onclick="showTitleScreen()">Cancel</button>
                </div>
                <div style="text-align: center; margin-top: 20px; color: #888; font-size: 0.9em;">
                    <p>🔥 Your fighter will unlock a special attack at level 10! 🔥</p>
                </div>
            </div>
        </div>

        <!-- Fighter Details Screen -->
        <div id="fighterScreen" class="game-screen">
            <button class="btn btn-secondary back-btn" onclick="showTitleScreen()">← Back</button>
            <button class="btn" style="background: #e74c3c; color: #fff; position: absolute; top: 20px; right: 20px;" onclick="console.log('Delete button clicked'); deleteFighter();">Delete Fighter</button>
            <div style="text-align: center; margin-bottom: 20px; margin-top: 60px;">
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-fight" onclick="findFight()" id="fightBtn" style="padding: 10px 18px; font-size: 0.9em;">Find Fight</button>
                    <button class="btn btn-primary" onclick="fightWithoutRest()" id="fightWithoutRestBtn" style="padding: 10px 18px; font-size: 0.9em;">Fight 💎</button>
                    <div id="fighterPaypalButton" class="paypal-button-container"></div>
                </div>
            </div>
            <div class="fight-status">
                <div class="diamonds-display">Diamonds: <span id="diamonds">0</span> 💎</div>
                <div class="cooldown-timer" id="cooldownTimer"></div>
            </div>
            <div class="fighter-details">
                <div class="stats-panel">
                    <h3 class="panel-title">Fighter Stats</h3>
                    <div id="fighterStats"></div>
                </div>
                <div class="inventory-panel">
                    <h3 class="panel-title">Equipment</h3>
                    <div id="fighterEquipment" class="equipment-grid"></div>
                </div>
            </div>
        </div>

        <!-- Fight Screen -->
        <div id="fightScreen" class="game-screen">
            <div class="fighters-display">
                <div class="fighter-card">
                    <h3 id="player1Name">Your Fighter</h3>
                    <div class="hp-bar">
                        <div id="player1HP" class="hp-fill" style="width: 100%"></div>
                    </div>
                    <div id="player1Info">HP: <span id="player1HPText">100/100</span></div>
                </div>
                <div class="fighter-card">
                    <h3 id="player2Name">Opponent</h3>
                    <div class="hp-bar">
                        <div id="player2HP" class="hp-fill" style="width: 100%"></div>
                    </div>
                    <div id="player2Info">HP: <span id="player2HPText">100/100</span></div>
                </div>
            </div>
            <div id="fightLog" class="fight-log"></div>
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="endFight()" id="endFightBtn" style="display: none;">Continue</button>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="game-screen">
            <button class="btn btn-secondary back-btn" onclick="showTitleScreen()">← Back</button>
            <div style="text-align: center; margin-bottom: 20px; margin-top: 60px;">
                <h2 style="color: #4ecdc4;">Top Fighters</h2>
            </div>
            <div id="leaderboardContent" class="leaderboard"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        var SUPABASE_URL = 'https://pmsbxvqavkoboxyhqjcc.supabase.co';
        var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtc2J4dnFhdmtvYm94eWhxamNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjA2OTMsImV4cCI6MjA3MzIzNjY5M30.9-0-glSFo66fOktfR6ineO8J4Ra8RLVXwytCb9jca9U';
        
        var gameState = {
            fighters: [],
            currentFighter: null,
            diamonds: 0,
            fightCooldownEnd: 0,
            unlockedSlots: [true, false, false, false, false],
            currentSlotIndex: 0,
            currentUser: null,
            isLoggedIn: false
        };

        var specialAttacks = ['Fury Strike', 'Power Slam', 'Devastator', 'Thunder Punch', 'Dragon Fist', 'Shadow Strike', 'Meteor Crash', 'Annihilator'];
        var equipmentSlots = ['Weapon', 'Off-Hand', 'Helmet', 'Shoulders', 'Gloves', 'Chest', 'Greaves', 'Boots'];

        // EmailJS Configuration
        var EMAILJS_PUBLIC_KEY = 'K5NaITkysVL6hhc2A';
        var EMAILJS_SERVICE_ID = 'service_22pzu4g';
        var EMAILJS_TEMPLATE_ID = 'template_38r3g5c';

        // PayPal Configuration - UPDATED TO PRODUCTION
        var PAYPAL_CLIENT_ID = 'AdSlJbETclTcEvT1E_8m2VuaNbtIvVvaPdAZEDRzMmwS1k8wJV2yhLaMNJ-B0zRLCC9PZrzEq2bFzzsu';

        // Initialize EmailJS
        function initEmailJS() {
            console.log('Checking EmailJS availability...');
            console.log('typeof emailjs:', typeof emailjs);
            console.log('Public key:', EMAILJS_PUBLIC_KEY);
            
            if (typeof emailjs !== 'undefined' && EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
                try {
                    emailjs.init(EMAILJS_PUBLIC_KEY);
                    console.log('EmailJS initialized successfully');
                    return true;
                } catch (error) {
                    console.error('EmailJS initialization error:', error);
                    return false;
                }
            } else {
                console.log('EmailJS not available or not configured');
                console.log('emailjs undefined:', typeof emailjs === 'undefined');
                console.log('Public key not set:', EMAILJS_PUBLIC_KEY === 'YOUR_EMAILJS_PUBLIC_KEY');
                return false;
            }
        }

        // Initialize PayPal Buttons
        function initPayPalButtons() {
            // Clear existing buttons and labels first to prevent duplicates
            var titleContainer = document.getElementById('titlePaypalButton');
            var fighterContainer = document.getElementById('fighterPaypalButton');
            
            if (titleContainer) {
                titleContainer.innerHTML = '';
                // Remove any existing labels
                var existingLabel = titleContainer.previousElementSibling;
                if (existingLabel && existingLabel.innerHTML && existingLabel.innerHTML.includes('Buy 20')) {
                    existingLabel.remove();
                }
            }
            if (fighterContainer) {
                fighterContainer.innerHTML = '';
                // Remove any existing labels
                var existingLabel = fighterContainer.previousElementSibling;
                if (existingLabel && existingLabel.innerHTML && existingLabel.innerHTML.includes('Buy 20')) {
                    existingLabel.remove();
                }
            }
            
            // Replace PayPal buttons with Shop buttons
            if (titleContainer) {
                titleContainer.innerHTML = '<button class="btn btn-primary" onclick="showDiamondShop()">Shop</button>';
            }
            
            if (fighterContainer) {
                fighterContainer.innerHTML = '<button class="btn btn-primary" onclick="showDiamondShop()">Shop</button>';
            }
        }

        // Show Diamond Shop Modal
        function showDiamondShop() {
            var existingModal = document.getElementById('diamondShopModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            var modalHTML = 
                '<div id="diamondShopModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;">' +
                    '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; padding: 20px; border-radius: 10px; border: 2px solid #4ecdc4; max-width: 450px; text-align: center; width: 90%; max-height: 90vh; overflow-y: auto;">' +
                        '<h3 style="color: #4ecdc4; margin-bottom: 20px;">Diamond Shop</h3>' +
                        '<p style="margin-bottom: 20px; color: #ccc; font-size: 0.9em;">Purchase diamonds to unlock slots, fight without cooldown, and more!</p>' +
                        '<div style="display: grid; gap: 15px; margin-bottom: 20px;">' +
                            '<div class="diamond-pack" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border: 1px solid #666;">' +
                                '<div style="color: #ffd93d; font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">20 💎</div>' +
                                '<div style="color: #4ecdc4; font-size: 1.2em; margin-bottom: 10px;">$0.99</div>' +
                                '<div id="pack1Button" style="min-height: 40px;"></div>' +
                            '</div>' +
                            '<div class="diamond-pack" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border: 1px solid #666;">' +
                                '<div style="color: #ffd93d; font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">45 💎</div>' +
                                '<div style="color: #4ecdc
