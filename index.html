<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RandoFight - Complete Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: linear-gradient(135deg, #1a1a2e, #16213e); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .title { text-align: center; font-size: 3em; margin-bottom: 30px; color: #ff6b6b; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .game-screen { display: none; }
        .test-btn { position: fixed; top: 10px; right: 10px; background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; z-index: 1000; }
        .test-btn:hover { background: #218838; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 100; }
        .fighter-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .fighter-slot { border: 2px solid #4ecdc4; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: rgba(78, 205, 196, 0.1); }
        .fighter-slot:hover { background: rgba(78, 205, 196, 0.2); transform: translateY(-2px); }
        .fighter-slot.locked { border-color: #666; background: rgba(102, 102, 102, 0.1); cursor: not-allowed; }
        .fighter-slot.locked:hover { background: rgba(102, 102, 102, 0.1); transform: none; }
        .slot-number { font-size: 1.2em; color: #4ecdc4; margin-bottom: 10px; }
        .fighter-name { font-size: 1.1em; margin: 10px 0; }
        .fighter-level { color: #ffd93d; }
        .fighter-wins { color: #6bcf7f; }
        .ui-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 1em; transition: all 0.3s ease; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: #4ecdc4; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #45b7aa; }
        .btn-secondary { background: #6c5ce7; color: #fff; }
        .btn-secondary:hover { background: #5f4fcf; }
        .btn-fight { background: #ff6b6b; color: #fff; font-weight: bold; box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3); }
        .btn-fight:hover:not(:disabled) { background: #ff5252; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255, 107, 107, 0.4); }
        .btn-fight:disabled { background: #666; box-shadow: none; }
        .creation-form { max-width: 400px; margin: 0 auto; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #4ecdc4; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #4ecdc4; border-radius: 4px; background: rgba(0, 0, 0, 0.3); color: #fff; font-family: inherit; }
        .fighter-details { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .stats-panel, .inventory-panel { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; }
        .panel-title { font-size: 1.3em; color: #4ecdc4; margin-bottom: 15px; text-align: center; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .equipment-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .equipment-slot { padding: 8px; border: 1px solid #666; border-radius: 4px; text-align: center; font-size: 0.8em; min-height: 80px; display: flex; flex-direction: column; background: rgba(0, 0, 0, 0.2); }
        .slot-name { font-size: 0.7em; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .item-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 3px; }
        .item-power { font-size: 0.8em; color: #ffd93d; font-weight: bold; }
        .item-name { font-size: 0.8em; font-weight: bold; }
        .fight-status { text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; }
        .diamonds-display { font-size: 1.2em; margin-bottom: 10px; color: #ffd93d; }
        .cooldown-timer { color: #e74c3c; font-weight: bold; }
        .fighters-display { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
        .fighter-card { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center; }
        .hp-bar { width: 100%; height: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #6bcf7f; border-radius: 10px; transition: width 0.5s ease; }
        .fight-log { background: rgba(0, 0, 0, 0.3); padding: 25px; border-radius: 10px; height: 300px; overflow-y: auto; margin-bottom: 20px; font-size: 1em; line-height: 1.8; font-family: 'Georgia', serif; color: #f0f0f0; }
        .fight-log p { margin-bottom: 15px; text-indent: 20px; }
        .story-title { font-size: 1.2em; font-weight: bold; color: #4ecdc4; text-align: center; margin-bottom: 20px; text-indent: 0; font-family: 'Courier New', monospace; }
        .damage { color: #ff6b6b; font-weight: bold; }
        .heal { color: #6bcf7f; font-weight: bold; }
        .special { color: #ffd93d; font-weight: bold; }
        .critical { color: #ff8c42; font-weight: bold; text-shadow: 0 0 5px rgba(255, 140, 66, 0.5); }
        .dodge { color: #74b9ff; font-style: italic; }
        .victory { color: #00b894; font-weight: bold; font-size: 1.1em; }
        .defeat { color: #e17055; font-weight: bold; }
        .level-up { color: #fdcb6e; font-weight: bold; font-size: 1.05em; text-shadow: 0 0 3px rgba(253, 203, 110, 0.5); }
        .exp-gain { color: #81ecec; }
        .leaderboard { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto; }
        .leaderboard-entry { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .leaderboard-entry:nth-child(1) { color: #ffd700; }
        .leaderboard-entry:nth-child(2) { color: #c0c0c0; }
        .leaderboard-entry:nth-child(3) { color: #cd7f32; }
        .common { color: #9d9d9d; }
        .uncommon { color: #1eff00; }
        .rare { color: #0070dd; }
        .epic { color: #a335ee; }
        .legendary { color: #ff8000; }
        .mythic { color: #ff0000; }
        @media (max-width: 768px) {
            .fighter-details { grid-template-columns: 1fr; }
            .fighters-display { grid-template-columns: 1fr; }
            .title { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">RandoFight</h1>
        <button class="test-btn" onclick="addTestDiamonds()">+5 üíé (Test)</button>

        <!-- Character Select Screen -->
        <div id="titleScreen" class="game-screen" style="display: block;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #4ecdc4; font-size: 2.5em; margin-bottom: 10px;">Character Select</h2>
                <p style="color: #ccc; font-size: 1.1em;">Choose your fighter or create a new one</p>
                <div style="background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; border-radius: 5px; padding: 10px; margin: 15px auto; max-width: 600px;">
                    <p style="color: #ffc107; font-size: 0.9em; margin: 0;">‚ö†Ô∏è <strong>Note:</strong> Character data is saved for this session only. Refreshing the page will reset all progress.</p>
                </div>
            </div>

            <div class="ui-buttons">
                <span style="color: #ffd93d; font-size: 1.2em; margin-right: 20px;">Diamonds: <span id="titleDiamonds">0</span> üíé</span>
                <button class="btn btn-primary" onclick="purchaseDiamonds()">Buy 10 üíé ($0.99)</button>
                <button class="btn btn-secondary" onclick="showLeaderboard()">Leaderboard</button>
            </div>

            <div class="fighter-slots">
                <div class="fighter-slot" id="slot-container-0">
                    <div class="slot-number">Slot 1</div>
                    <div class="fighter-name">Empty Slot</div>
                    <div>Click to create fighter</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-1">
                    <div class="slot-number">Slot 2</div>
                    <div>Purchase this slot for 100 üíé</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-2">
                    <div class="slot-number">Slot 3</div>
                    <div>Purchase this slot for 100 üíé</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-3">
                    <div class="slot-number">Slot 4</div>
                    <div>Purchase this slot for 100 üíé</div>
                </div>
                <div class="fighter-slot locked" id="slot-container-4">
                    <div class="slot-number">Slot 5</div>
                    <div>Purchase this slot for 100 üíé</div>
                </div>
            </div>
        </div>

        <!-- Fighter Creation Screen -->
        <div id="creationScreen" class="game-screen">
            <button class="btn btn-secondary back-btn" onclick="showTitleScreen()">‚Üê Back</button>
            <div class="creation-form">
                <h2 style="text-align: center; margin-bottom: 20px; color: #4ecdc4;">Create New Fighter</h2>
                <div class="form-group">
                    <label for="fighterName">Fighter Name:</label>
                    <input type="text" id="fighterName" maxlength="20" placeholder="Enter fighter name">
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="createFighter()">Create Fighter</button>
                    <button class="btn btn-secondary" onclick="showTitleScreen()">Cancel</button>
                </div>
                <div style="text-align: center; margin-top: 20px; color: #888; font-size: 0.9em;">
                    <p>üî• Your fighter will unlock a special attack at level 10! üî•</p>
                </div>
            </div>
        </div>

        <!-- Fighter Details Screen -->
        <div id="fighterScreen" class="game-screen">
            <button class="btn btn-secondary back-btn" onclick="showTitleScreen()">‚Üê Back</button>
            <div style="text-align: center; margin-bottom: 20px; margin-top: 60px;">
                <button class="btn btn-fight" onclick="findFight()" id="fightBtn">Find Fight</button>
                <button class="btn btn-primary" onclick="fightWithoutRest()" id="fightWithoutRestBtn">Fight üíé</button>
                <button class="btn btn-primary" onclick="purchaseDiamonds()">Buy 10 üíé ($0.99)</button>
            </div>
            <div class="fight-status">
                <div class="diamonds-display">Diamonds: <span id="diamonds">0</span> üíé</div>
                <div class="cooldown-timer" id="cooldownTimer"></div>
            </div>
            <div class="fighter-details">
                <div class="stats-panel">
                    <h3 class="panel-title">Fighter Stats</h3>
                    <div id="fighterStats"></div>
                </div>
                <div class="inventory-panel">
                    <h3 class="panel-title">Equipment</h3>
                    <div id="fighterEquipment" class="equipment-grid"></div>
                </div>
            </div>
        </div>

        <!-- Fight Screen -->
        <div id="fightScreen" class="game-screen">
            <div class="fighters-display">
                <div class="fighter-card">
                    <h3 id="player1Name">Your Fighter</h3>
                    <div class="hp-bar">
                        <div id="player1HP" class="hp-fill" style="width: 100%"></div>
                    </div>
                    <div id="player1Info">HP: <span id="player1HPText">100/100</span></div>
                </div>
                <div class="fighter-card">
                    <h3 id="player2Name">Opponent</h3>
                    <div class="hp-bar">
                        <div id="player2HP" class="hp-fill" style="width: 100%"></div>
                    </div>
                    <div id="player2Info">HP: <span id="player2HPText">100/100</span></div>
                </div>
            </div>
            <div id="fightLog" class="fight-log"></div>
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="endFight()" id="endFightBtn" style="display: none;">Continue</button>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="game-screen">
            <button class="btn btn-secondary back-btn" onclick="showTitleScreen()">‚Üê Back</button>
            <div style="text-align: center; margin-bottom: 20px; margin-top: 60px;">
                <h2 style="color: #4ecdc4;">Top Fighters</h2>
            </div>
            <div id="leaderboardContent" class="leaderboard"></div>
        </div>
    </div>

    <script>
        var gameState = {
            fighters: [],
            currentFighter: null,
            diamonds: 0,
            fightCooldownEnd: 0,
            unlockedSlots: [true, false, false, false, false],
            currentSlotIndex: 0
        };

        var specialAttacks = ['Fury Strike', 'Power Slam', 'Devastator', 'Thunder Punch', 'Dragon Fist', 'Shadow Strike', 'Meteor Crash', 'Annihilator'];
        var equipmentSlots = ['Weapon', 'Off-Hand', 'Helmet', 'Shoulders', 'Gloves', 'Chest', 'Greaves', 'Boots'];

        function saveGameData() {
            try {
                window.gameDataStorage = JSON.stringify({
                    fighters: gameState.fighters,
                    diamonds: gameState.diamonds,
                    fightCooldownEnd: gameState.fightCooldownEnd,
                    unlockedSlots: gameState.unlockedSlots
                });
            } catch (e) {
                console.log('Save failed:', e);
            }
        }

        function loadGameData() {
            try {
                if (window.gameDataStorage) {
                    var data = JSON.parse(window.gameDataStorage);
                    gameState.fighters = data.fighters || [];
                    gameState.diamonds = data.diamonds || 0;
                    gameState.fightCooldownEnd = data.fightCooldownEnd || 0;
                    gameState.unlockedSlots = data.unlockedSlots || [true, false, false, false, false];
                }
            } catch (e) {
                console.log('Load failed:', e);
            }
        }

        function hideAll() {
            var screens = document.querySelectorAll('.game-screen');
            for (var i = 0; i < screens.length; i++) {
                screens[i].style.display = 'none';
            }
        }

        function showTitleScreen() {
            hideAll();
            document.getElementById('titleScreen').style.display = 'block';
            updateFighterSlots();
            var titleDiamonds = document.getElementById('titleDiamonds');
            if (titleDiamonds) {
                titleDiamonds.textContent = gameState.diamonds;
            }
        }

        function showCreationScreen() {
            hideAll();
            document.getElementById('creationScreen').style.display = 'block';
            document.getElementById('fighterName').value = '';
        }

        function showFighterScreen() {
            hideAll();
            document.getElementById('fighterScreen').style.display = 'block';
            updateFighterDisplay();
            updateFightStatus();
        }

        function showLeaderboard() {
            hideAll();
            document.getElementById('leaderboardScreen').style.display = 'block';
            updateLeaderboard();
        }

        function createFighter() {
            var name = document.getElementById('fighterName').value.trim();
            if (!name) {
                alert('Please enter a fighter name!');
                return;
            }

            var fighter = {
                name: name,
                birthplace: 'Unknown',
                level: 1,
                exp: 0,
                expRequired: 100,
                hp: 100,
                maxHp: 100,
                wins: 0,
                stats: { strength: 1, toughness: 1, agility: 1, luck: 1, speed: 1 },
                specialAttack: null,
                equipment: {
                    weapon: { name: 'Wooden Stick', type: 'weapon', slot: 'weapon', power: 5, level: 1, rarity: 'common', statType: 'Damage' },
                    offHand: null, helmet: null, shoulders: null, gloves: null, chest: null, greaves: null, boots: null
                }
            };

            gameState.fighters[gameState.currentSlotIndex] = fighter;
            
            var isFirstFighter = gameState.fighters.filter(function(f) { return f !== null && f !== undefined; }).length === 1;
            if (isFirstFighter && gameState.diamonds === 0) {
                gameState.diamonds = 10;
                alert('Welcome to RandoFight! You have received 10 free diamonds to get you started!');
            }
            
            saveGameData();
            gameState.currentFighter = fighter;
            showFighterScreen();
        }

        function selectFighter(slotIndex) {
            if (!gameState.unlockedSlots[slotIndex]) return;
            
            if (gameState.fighters[slotIndex]) {
                gameState.currentFighter = gameState.fighters[slotIndex];
                showFighterScreen();
            } else {
                gameState.currentSlotIndex = slotIndex;
                showCreationScreen();
            }
        }

        function updateFighterSlots() {
            for (var i = 0; i < 5; i++) {
                var slotContainer = document.getElementById('slot-container-' + i);
                if (!slotContainer) continue;

                var fighter = gameState.fighters[i];
                slotContainer.innerHTML = '';
                slotContainer.className = 'fighter-slot';
                slotContainer.onclick = null;
                
                var slotNumber = document.createElement('div');
                slotNumber.className = 'slot-number';
                slotNumber.textContent = 'Slot ' + (i + 1);
                slotContainer.appendChild(slotNumber);
                
                if (fighter) {
                    var fighterContent = document.createElement('div');
                    fighterContent.innerHTML = 
                        '<div class="fighter-name">' + fighter.name + '</div>' +
                        '<div class="fighter-level">Level ' + fighter.level + '</div>' +
                        '<div class="fighter-wins">' + fighter.wins + ' wins</div>';
                    slotContainer.appendChild(fighterContent);
                    slotContainer.onclick = (function(index) {
                        return function() { selectFighter(index); };
                    })(i);
                } else if (gameState.unlockedSlots[i]) {
                    var emptyContent = document.createElement('div');
                    emptyContent.innerHTML = 
                        '<div class="fighter-name">Empty Slot</div>' +
                        '<div>Click to create fighter</div>';
                    slotContainer.appendChild(emptyContent);
                    slotContainer.onclick = (function(index) {
                        return function() { selectFighter(index); };
                    })(i);
                } else {
                    slotContainer.classList.add('locked');
                    var lockedContent = document.createElement('div');
                    lockedContent.innerHTML = 'Purchase this slot for 100 üíé';
                    slotContainer.appendChild(lockedContent);
                    slotContainer.onclick = (function(index) {
                        return function() { purchaseSlot(index); };
                    })(i);
                }
            }
        }

        function purchaseSlot(slotIndex) {
            if (gameState.unlockedSlots[slotIndex]) return;
            
            if (gameState.diamonds < 100) {
                alert('You need 100 diamonds to unlock this slot! You currently have ' + gameState.diamonds + ' diamonds.');
                return;
            }
            
            if (confirm('Purchase fighter slot ' + (slotIndex + 1) + ' for 100 diamonds?')) {
                gameState.diamonds -= 100;
                gameState.unlockedSlots[slotIndex] = true;
                saveGameData();
                updateFighterSlots();
                alert('Fighter slot ' + (slotIndex + 1) + ' unlocked!');
            }
        }

        function updateFighterDisplay() {
            var fighter = gameState.currentFighter;
            if (!fighter) return;

            var specialDisplay;
            if (fighter.specialAttack && fighter.specialAttack.name) {
                var specialDamage = Math.floor(fighter.level * 10 + ((fighter.stats.strength - 1) * 3 + 10));
                specialDisplay = '<div class="stat-row"><span>Special Attack:</span> <span class="special">' + fighter.specialAttack.name + ' (' + specialDamage + ' damage)</span></div>';
            } else {
                specialDisplay = '<div class="stat-row"><span>Special Attack:</span> <span style="color: #888;">Unlocks at Level 10</span></div>';
            }

            var strengthBonus = (fighter.stats.strength - 1) * 2;
            var toughnessBonus = fighter.stats.toughness >= 2 ? (fighter.stats.toughness - 1) * 3 : 0;
            var speedBonus = (fighter.stats.speed - 1) * 1;
            var luckBonus = fighter.stats.luck >= 2 ? (fighter.stats.luck - 1) * 3 : 0;

            var statsHTML = 
                '<div class="stat-row"><span>Name:</span> <span>' + fighter.name + '</span></div>' +
                '<div class="stat-row"><span>Level:</span> <span>' + fighter.level + '</span></div>' +
                '<div class="stat-row"><span>EXP:</span> <span>' + fighter.exp + '/' + fighter.expRequired + '</span></div>' +
                '<div class="stat-row"><span>Wins:</span> <span class="fighter-wins">' + fighter.wins + '</span></div>' +
                '<div class="stat-row"><span>HP:</span> <span>' + fighter.hp + '/' + fighter.maxHp + '</span></div>' +
                '<hr style="margin: 10px 0; border-color: rgba(255,255,255,0.2);">' +
                '<div class="stat-row"><span>Strength <span style="color: #888; font-size: 0.8em;">(+' + strengthBonus + ' damage)</span>:</span> <span>' + fighter.stats.strength + '</span></div>' +
                '<div class="stat-row"><span>Toughness <span style="color: #888; font-size: 0.8em;">(-' + toughnessBonus + '% damage taken)</span>:</span> <span>' + fighter.stats.toughness + '</span></div>' +
                '<div class="stat-row"><span>Agility <span style="color: #888; font-size: 0.8em;">(dodge chance)</span>:</span> <span>' + fighter.stats.agility + '</span></div>' +
                '<div class="stat-row"><span>Luck <span style="color: #888; font-size: 0.8em;">(+' + luckBonus + '% crit chance)</span>:</span> <span>' + fighter.stats.luck + '</span></div>' +
                '<div class="stat-row"><span>Speed <span style="color: #888; font-size: 0.8em;">(+' + speedBonus + '% hit chance)</span>:</span> <span>' + fighter.stats.speed + '</span></div>' +
                '<hr style="margin: 10px 0; border-color: rgba(255,255,255,0.2);">' +
                specialDisplay;
            
            document.getElementById('fighterStats').innerHTML = statsHTML;

            var equipmentElement = document.getElementById('fighterEquipment');
            equipmentElement.innerHTML = '';
            
            for (var i = 0; i < equipmentSlots.length; i++) {
                var slot = equipmentSlots[i];
                var item = fighter.equipment[slot.toLowerCase().replace('-', '')];
                var slotDiv = document.createElement('div');
                slotDiv.className = 'equipment-slot';
                
                if (item && item.statType) {
                    slotDiv.innerHTML = 
                        '<div class="slot-name">' + slot + '</div>' +
                        '<div class="item-content">' +
                            '<div class="item-power">+' + item.power + ' ' + item.statType + '</div>' +
                            '<div class="item-name ' + item.rarity + '">' + item.name + '</div>' +
                        '</div>';
                } else {
                    slotDiv.innerHTML = 
                        '<div class="slot-name">' + slot + '</div>' +
                        '<div class="item-content">' +
                            '<div class="item-name">Empty</div>' +
                        '</div>';
                }
                equipmentElement.appendChild(slotDiv);
            }
        }

        function updateFightStatus() {
            var now = Date.now();
            var fightBtn = document.getElementById('fightBtn');
            var fightWithoutRestBtn = document.getElementById('fightWithoutRestBtn');
            var cooldownTimer = document.getElementById('cooldownTimer');
            var diamondsDisplay = document.getElementById('diamonds');

            if (diamondsDisplay) {
                diamondsDisplay.textContent = gameState.diamonds;
            }

            if (fightWithoutRestBtn) {
                fightWithoutRestBtn.disabled = gameState.diamonds <= 0;
                fightWithoutRestBtn.textContent = 'Fight üíé';
            }

            if (now < gameState.fightCooldownEnd) {
                var timeLeft = gameState.fightCooldownEnd - now;
                var seconds = Math.ceil(timeLeft / 1000);
                
                if (fightBtn) {
                    fightBtn.disabled = true;
                    fightBtn.textContent = 'Resting (' + seconds + 's)';
                }
                
                if (cooldownTimer) {
                    cooldownTimer.textContent = 'Rest time remaining: ' + seconds + ' seconds';
                }
            } else {
                if (fightBtn) {
                    fightBtn.disabled = false;
                    fightBtn.textContent = 'Find Fight';
                }
                
                if (cooldownTimer) {
                    cooldownTimer.textContent = '';
                }
            }
        }

        function findFight() {
            var now = Date.now();
            if (now < gameState.fightCooldownEnd) {
                alert('You must rest before fighting again!');
                return;
            }
            if (!gameState.currentFighter) {
                alert('No fighter selected!');
                return;
            }
            
            var opponent = generateOpponent(gameState.currentFighter.level);
            startFight(gameState.currentFighter, opponent);
        }

        function fightWithoutRest() {
            if (gameState.diamonds <= 0) {
                alert('You need Diamonds to fight without rest!');
                return;
            }
            gameState.diamonds--;
            saveGameData();
            var opponent = generateOpponent(gameState.currentFighter.level);
            startFight(gameState.currentFighter, opponent);
        }

        function addTestDiamonds() {
            gameState.diamonds += 5;
            saveGameData();
            updateFightStatus();
            var titleDiamonds = document.getElementById('titleDiamonds');
            if (titleDiamonds) {
                titleDiamonds.textContent = gameState.diamonds;
            }
            alert('Added 5 test diamonds!');
        }

        function purchaseDiamonds() {
            if (confirm('Purchase 10 Diamonds for $1.99?')) {
                gameState.diamonds += 10;
                saveGameData();
                updateFightStatus();
                var titleDiamonds = document.getElementById('titleDiamonds');
                if (titleDiamonds) {
                    titleDiamonds.textContent = gameState.diamonds;
                }
                alert('10 Diamonds purchased!');
            }
        }

        function generateOpponent(level) {
            var names = ['ShadowKnight92', 'DragonSlayer', 'IronFist2024', 'BlazeFighter', 'StormWarrior'];
            var places = ['New York', 'London', 'Tokyo', 'Paris', 'Sydney'];
            
            var opponentLevel = Math.max(1, level + Math.floor(Math.random() * 3) - 1);
            var opponentMaxHp = Math.floor(100 + (opponentLevel - 1) * 20);

            return {
                name: names[Math.floor(Math.random() * names.length)],
                birthplace: places[Math.floor(Math.random() * places.length)],
                level: opponentLevel,
                hp: opponentMaxHp,
                maxHp: opponentMaxHp,
                currentHp: opponentMaxHp,
                wins: Math.floor(opponentLevel * 3),
                stats: {
                    strength: Math.floor(1 + (opponentLevel - 1) * 2),
                    toughness: Math.floor(1 + (opponentLevel - 1) * 2),
                    agility: Math.floor(1 + (opponentLevel - 1) * 2),
                    luck: Math.floor(1 + (opponentLevel - 1) * 2),
                    speed: Math.floor(1 + (opponentLevel - 1) * 2)
                },
                specialAttack: {
                    name: specialAttacks[Math.floor(Math.random() * specialAttacks.length)]
                }
            };
        }

        function startFight(player, opponent) {
            hideAll();
            document.getElementById('fightScreen').style.display = 'block';
            
            player.currentHp = player.maxHp;
            opponent.currentHp = opponent.maxHp;

            document.getElementById('player1Name').textContent = player.name + ' (Level ' + player.level + ', ' + player.wins + ' wins)';
            document.getElementById('player2Name').textContent = opponent.name + ' (Level ' + opponent.level + ', ' + opponent.wins + ' wins)';
            
            document.getElementById('player1HPText').textContent = Math.floor(player.currentHp) + '/' + player.maxHp;
            document.getElementById('player2HPText').textContent = Math.floor(opponent.currentHp) + '/' + opponent.maxHp;
            document.getElementById('player1HP').style.width = '100%';
            document.getElementById('player2HP').style.width = '100%';

            var fightLog = document.getElementById('fightLog');
            fightLog.innerHTML = '';

            addToFightLog('<div class="story-title">~ The Tale of ' + player.name + ' vs ' + opponent.name + ' ~</div>');
            addToFightLog('In the ancient colosseum, a legendary warrior named ' + player.name + ' prepared for battle. Across the arena, ' + opponent.name + ' from ' + opponent.birthplace + ' stood ready, their eyes burning with determination.');
            addToFightLog('The crowd roared as these two mighty champions faced each other. The air was thick with anticipation, for only one would emerge victorious from this epic confrontation.');
            
            setTimeout(function() { simulateFight(player, opponent); }, 2000);
        }

        function simulateFight(player, opponent) {
            var turn = 1;
            var maxTurns = 50;
            
            setTimeout(function() {
                addToFightLog('The battle commenced as both warriors circled each other, their weapons gleaming in the arena light. The crowd held its breath, waiting for the first strike...');
            }, 1000);
            
            var fightInterval = setInterval(function() {
                if (player.currentHp <= 0 || opponent.currentHp <= 0 || turn > maxTurns) {
                    clearInterval(fightInterval);
                    endCombat(player, opponent);
                    return;
                }

                var playerSpeed = player.stats.speed + Math.random() * 10;
                var opponentSpeed = opponent.stats.speed + Math.random() * 10;

                if (playerSpeed >= opponentSpeed) {
                    performAttack(player, opponent);
                    if (opponent.currentHp > 0) {
                        setTimeout(function() { 
                            if (player.currentHp > 0) {
                                performAttack(opponent, player); 
                            }
                        }, 1500);
                    }
                } else {
                    performAttack(opponent, player);
                    if (player.currentHp > 0) {
                        setTimeout(function() { 
                            if (opponent.currentHp > 0) {
                                performAttack(player, opponent); 
                            }
                        }, 1500);
                    }
                }

                turn++;
            }, 3500);
        }

        function performAttack(attacker, defender) {
            var baseDamage = Math.floor((attacker.stats.strength + 10) * (0.8 + Math.random() * 0.4));
            var damage = baseDamage;
            
            var critChance = attacker.stats.luck * 0.05;
            var isCrit = Math.random() < critChance;
            
            var specialChance = 0.2;
            var canUseSpecial = attacker.specialAttack && attacker.specialAttack.name && attacker.level >= 10;
            var isSpecial = canUseSpecial && Math.random() < specialChance;
            
            var weaponName = attacker.equipment && attacker.equipment.weapon ? 
                attacker.equipment.weapon.name : 'bare fists';

            var dodgeChance = defender.stats.agility * 0.03;
            if (Math.random() < dodgeChance) {
                addToFightLog('<span class="dodge">' + attacker.name + ' lunged forward with their ' + weaponName + ', but ' + defender.name + ' gracefully danced away from the strike, their movements fluid as water.</span>');
                return;
            }
            
            if (isSpecial) {
                var specialDamage = Math.floor(attacker.level * 15 + (attacker.stats.strength + 10) * 0.5);
                damage = specialDamage;
                addToFightLog('<span class="special">' + attacker.name + ' channeled their inner power and unleashed the devastating ' + attacker.specialAttack.name + '! Energy crackled through the air as the attack struck ' + defender.name + ' with tremendous force, dealing <span class="damage">' + damage + ' damage</span>.</span>');
            } else {
                if (isCrit) {
                    damage *= 2;
                    addToFightLog('<span class="critical">In a moment of perfect precision, ' + attacker.name + ' found a gap in ' + defender.name + '\'s defenses! Their ' + weaponName + ' struck true, delivering a critical blow for ' + damage + ' damage! The crowd erupted in cheers.</span>');
                } else {
                    addToFightLog(attacker.name + ' pressed their advantage, swinging their ' + weaponName + ' in a calculated strike. The weapon connected solidly with ' + defender.name + ', dealing <span class="damage">' + damage + ' damage</span> as the battle intensified.');
                }
            }

            defender.currentHp = Math.max(0, defender.currentHp - damage);
            updateHPDisplay(attacker, defender);
        }

        function updateHPDisplay(attacker, defender) {
            var isPlayerAttacker = attacker.name === gameState.currentFighter.name;
            
            if (isPlayerAttacker) {
                var newHP = Math.floor(defender.currentHp) + '/' + defender.maxHp;
                document.getElementById('player2HPText').textContent = newHP;
                document.getElementById('player2HP').style.width = (defender.currentHp / defender.maxHp) * 100 + '%';
            } else {
                var newHP = Math.floor(defender.currentHp) + '/' + defender.maxHp;
                document.getElementById('player1HPText').textContent = newHP;
                document.getElementById('player1HP').style.width = (defender.currentHp / defender.maxHp) * 100 + '%';
            }
        }

        function endCombat(player, opponent) {
            var playerWon = opponent.currentHp <= 0;
            
            setTimeout(function() {
                if (playerWon) {
                    addToFightLog('<span class="victory">As the dust settled in the arena, ' + opponent.name + ' collapsed to their knees, unable to continue. ' + player.name + ' stood victorious, breathing heavily but triumphant. The crowd rose to their feet, their cheers echoing across the ancient stones.</span>');
                    player.wins++;
                    giveRewards(player, true);
                } else {
                    addToFightLog('<span class="defeat">Despite their valiant efforts, ' + player.name + ' was overwhelmed by ' + opponent.name + '\'s superior skill. As they fell to the arena floor, the crowd fell silent, respecting the courage shown in defeat.</span>');
                    giveRewards(player, false);
                }
                
                gameState.fightCooldownEnd = Date.now() + 30000;
                player.hp = player.maxHp;
                saveGameData();
                document.getElementById('endFightBtn').style.display = 'block';
            }, 2000);
        }

        function giveRewards(fighter, won) {
            var baseExp = 50 + (fighter.level * 10);
            var expGained = won ? baseExp : Math.floor(baseExp * 0.3);
            
            fighter.exp += expGained;
            
            if (won) {
                addToFightLog('<span class="exp-gain">Through this hard-fought victory, ' + fighter.name + ' gained valuable experience (+' + expGained + ' EXP), growing stronger and wiser in the ways of combat.</span>');
            } else {
                addToFightLog('<span class="exp-gain">Even in defeat, ' + fighter.name + ' learned from the battle, gaining ' + expGained + ' experience points that would serve them well in future conflicts.</span>');
            }

            if (fighter.exp >= fighter.expRequired && fighter.level < 100) {
                levelUp(fighter);
            }
        }

        function levelUp(fighter) {
            fighter.level++;
            fighter.exp -= fighter.expRequired;
            fighter.expRequired = Math.floor(fighter.expRequired * 1.5);
            fighter.maxHp += 20;
            fighter.hp = fighter.maxHp;

            var stats = Object.keys(fighter.stats);
            var randomStat = stats[Math.floor(Math.random() * stats.length)];
            fighter.stats[randomStat]++;

            if (fighter.level === 10 && (!fighter.specialAttack || !fighter.specialAttack.name)) {
                var randomSpecialAttack = specialAttacks[Math.floor(Math.random() * specialAttacks.length)];
                fighter.specialAttack = { name: randomSpecialAttack };
                
                var specialUnlockTexts = [
                    '<span class="level-up">LEVEL UP! ' + fighter.name + ' reaches level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' increased!</span> <span class="special">Special attack unlocked: ' + randomSpecialAttack + '!</span>',
                    '<span class="level-up">' + fighter.name + ' ascends to level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' grows stronger!</span> <span class="special">New technique mastered: ' + randomSpecialAttack + '!</span>',
                    '<span class="level-up">Level ' + fighter.level + ' achieved!</span> <span class="heal">' + randomStat + ' improved!</span> <span class="special">' + fighter.name + ' learns ' + randomSpecialAttack + '!</span>',
                    '<span class="level-up">' + fighter.name + ' reaches new heights! Level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' enhanced!</span> <span class="special">Ultimate move unlocked: ' + randomSpecialAttack + '!</span>'
                ];
                addToFightLog(specialUnlockTexts[Math.floor(Math.random() * specialUnlockTexts.length)]);
            } else {
                var levelUpTexts = [
                    '<span class="level-up">LEVEL UP! ' + fighter.name + ' reaches level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' increased!</span>',
                    '<span class="level-up">' + fighter.name + ' grows stronger! Level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' improved!</span>',
                    '<span class="level-up">New level achieved! ' + fighter.name + ' is now level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' enhanced!</span>',
                    '<span class="level-up">' + fighter.name + ' ascends to level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' grows stronger!</span>',
                    '<span class="level-up">Power surge! ' + fighter.name + ' reaches level ' + fighter.level + '!</span> <span class="heal">' + randomStat + ' boosted!</span>'
                ];
                addToFightLog(levelUpTexts[Math.floor(Math.random() * levelUpTexts.length)]);
            }
        }

        function addToFightLog(message) {
            var fightLog = document.getElementById('fightLog');
            var p = document.createElement('p');
            p.innerHTML = message;
            fightLog.appendChild(p);
            fightLog.scrollTop = fightLog.scrollHeight;
        }

        function endFight() {
            document.getElementById('endFightBtn').style.display = 'none';
            showFighterScreen();
        }

        function updateLeaderboard() {
            var content = document.getElementById('leaderboardContent');
            var leaderboard = [];

            for (var i = 0; i < gameState.fighters.length; i++) {
                var fighter = gameState.fighters[i];
                if (fighter) {
                    leaderboard.push({
                        name: fighter.name,
                        wins: fighter.wins,
                        level: fighter.level
                    });
                }
            }

            leaderboard.sort(function(a, b) {
                return b.wins - a.wins;
            });
            
            if (leaderboard.length === 0) {
                content.innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #888;">' +
                        '<p>No fighters yet!</p>' +
                        '<p>Create some fighters and start winning battles to appear on the leaderboard!</p>' +
                    '</div>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < leaderboard.length; i++) {
                var entry = leaderboard[i];
                var rank = i + 1;
                var medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank + '.';
                
                html += 
                    '<div class="leaderboard-entry">' +
                        '<span>' + medal + ' ' + entry.name + ' (Level ' + entry.level + ')</span>' +
                        '<span>' + entry.wins + ' wins</span>' +
                    '</div>';
            }
            
            content.innerHTML = html;
        }

        function initGame() {
            loadGameData();
            showTitleScreen();
            setInterval(updateFightStatus, 1000);
        }

        window.addEventListener('load', initGame);
    </script>
</body>
</html>
